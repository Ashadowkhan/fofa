# 在资产梳理过程中，如何通过证书有效地排除干扰 #

## 问题所在 ##

FOFA工程师在对企业进行资产梳理时，会通过使用cert.is_valid语法的方式，快速地验证资产的证书是否是由受信任的证书颁发机构所颁发，并以此来判断资产的可信性。

 
但是我们在资产梳理的过程中，发现还会出现一种情况，比如使用语法，`cert="fofa.info" && cert.is_valid=true`，我们判断了证书是否可信，但是我们还是会发现很多不是FOFA的资产，存在这个问题的原因是证书泄露或别人把域名解析到我们的IP等。


[![p92vKQP.png](https://s1.ax1x.com/2023/05/16/p92vKQP.png)](https://imgse.com/i/p92vKQP)

另一个情况也是普遍存在的，即便证书是可信的，但是它的证书已经过期了，但是在做资产梳理的时候也是需要进行筛选判定的。

所以怎么在通过证书进行资产收集时，避开这些无用资产也就是我们需要解决的问题。

 
## 解决思路 ##

我们首先针对这两个问题进行了定位：

 

- 证书可信，但是是否过期的判断；
- 证书可信，但是该证书是否和资产匹配。
 

**第一个问题**很好解决，针对于证书的是否过期字段进行判断就可以了。

因为关于证书是否过期，是资产合规性判断的一项。

[![p92vnzt.png](https://s1.ax1x.com/2023/05/16/p92vnzt.png)](https://imgse.com/i/p92vnzt)

针对于**第二个问题**，证书可信但是他的域名和证书中给出的有效域名却是不匹配的。我们是不是可以用这种方式规避到干扰数据呢？当然在此过程中我们也要解决很多问题：比如同意同一证书下可能是多个域名、协议数据和网站数据下证书的不同判断标准等。

我们也在探索中发现了有意思的一点，那就是**当在浏览器中访问https时，浏览器会检查访问的host是否与证书中的匹配，如果不匹配，浏览器会显示该证书不可信。**

但是，大部分的https网站的证书中只包含了域名，使用IP直接访问的话，会返回证书错误。但是实际在资产梳理的过程中，这部分为本身资产的数据是需要的，所以仅仅只像浏览器一样，**判断host和证书匹配是不够的，IP绑定了证书的情况也需要被考虑到**。

[![p9oNFij.md.png](https://s1.ax1x.com/2023/05/22/p9oNFij.md.png)](https://imgse.com/i/p9oNFij)


最终我们在此基础上添加了新的证书筛选语法：`cert.is_match`和`cert.is_expired`两个语法来解决这个资产收集中的问题。

 

我们将以前的判断语法和新添加的两个语法放在一起进行解释：

 

- `cert.is_valid` 证书是否可信（非自签名的验证是否为信任证书机构颁发，true可信、false不可信）

- `cert.is_match` 证书是否匹配（资产的域名和证书使用者的域名是否匹配，true匹配、false不匹配）

- `cert.is_expired` 证书是否过期（true为已过期、false为未过期）

 

我们回到举证的案例中，`cert="fofa.info" && cert.is_valid=true && cert.is_match=true && cert.is_expired=false `就可以将干扰资产排除掉。

[![p9oNYy6.md.png](https://s1.ax1x.com/2023/05/22/p9oNYy6.md.png)](https://imgse.com/i/p9oNYy6)



关于新添加的证书验证语法，可以在资产收集的过程中起到了很大的作用，包括FOFA开放实验室里的攻击面梳理也已经应用了这个语法。

同时三种判断方式的语法可以单一使用，也可以多组合使用，更大程度上地给到了大家可选性。欢迎各位表哥们在 https://en.fofa.info 开发这套语法，发现他更多的新姿势。
