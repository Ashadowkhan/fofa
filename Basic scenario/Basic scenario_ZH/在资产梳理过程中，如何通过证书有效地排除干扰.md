# 在资产梳理过程中，如何通过证书有效地排除干扰 #

## 问题所在 ##

FOFA工程师在对企业进行资产梳理时，会通过使用cert.is_valid语法的方式，快速地验证资产的证书是否是由受信任的证书颁发机构所颁发，并以此来判断资产的可信性。比如使用语法：`cert="fofa.info" && cert.is_valid=true`
 
但是我们在资产梳理的过程中，发现还会出现一种情况。我们判断了证书是否可信，但是我们还是会发现很多不是FOFA的资产，存在这个问题的原因是证书泄露或别人把域名解析到我们的IP等。


[![p92vKQP.png](https://s1.ax1x.com/2023/05/16/p92vKQP.png)](https://imgse.com/i/p92vKQP)


所以，在资产梳理过程中，如何通过证书有效地排除干扰数据也就是我们需要去解决的问题。

 
## 解决思路 ##

我们针对这个问题进行了定位，这种域名和证书中给出的有效域名不匹配的情况，要如何排除呢？或者说如何界定他就是干扰数据呢？

我们先根据行业惯例来进行解决，**当在浏览器中访问https时，浏览器会检查访问的host是否与证书中的匹配，如果不匹配，浏览器会显示该证书不可信。**

但是我们发现了很多问题！比如：大部分的https网站的证书中只包含了域名，使用IP直接访问的话，会返回证书错误。但是实际在资产梳理的过程中，这部分为本身资产的数据是需要的，所以仅仅只像浏览器一样，**判断host和证书匹配是不够的，IP绑定了证书的情况也需要被考虑到**。


[![p9oNFij.md.png](https://s1.ax1x.com/2023/05/22/p9oNFij.md.png)](https://imgse.com/i/p9oNFij)

同时我们发现，对于资产类型而言，除了上文中提到的证书可信但是域名不匹配的干扰数据这种情况，还有一种情况是**当自家的资产与证书共享时，多个域名使用同一证书进行加密通信。这意味着这些域名共享相同的公钥和私钥。在建立客户端与服务器连接时，需要验证证书中的域名与实际访问的域名是否匹配。**

我们看这个例子：

[![p9TuMNV.md.png](https://s1.ax1x.com/2023/05/23/p9TuMNV.md.png)](https://imgse.com/i/p9TuMNV)

上面的搜索结果中，IP肯定都是该银行的资产，因为只有有证书私钥的情况下才可以绑定证书。根据这个案例的分析，确实存在一个情况：该银行拥有特定的域名资产，但证书中却没有包含该域名信息。在进行资产收集时，我们仍然需要获取这些资产。

这种情况可能出现在一些特定的配置或管理问题中，导致证书与实际域名不完全匹配。

如果使用常规的浏览器检查方式，那么在资产梳理的过程中，我们就会直接丢失类似于案例中的真实资产。

我们为的不是给资产打上更多的标签，而是给用户更多资产收集可选项。

最终，我们在研究的基础上，添加了cert.is_match语法，同时顺便解决了证书是否过期的判断。

我们将以前的判断语法和新添加的两个语法放在一起进行解释：


- `cert.is_valid` 证书是否可信（非自签名的验证是否为信任证书机构颁发，true可信、false不可信）

- `cert.is_match` 证书是否匹配（资产的域名和证书使用者的域名是否匹配，true匹配、false不匹配）

- `cert.is_expired` 证书是否过期（true为已过期、false为未过期）

 

我们回到举证的案例中，`cert="fofa.info" && cert.is_valid=true && cert.is_match=true `就可以将干扰资产排除掉。

[![p9oNYy6.md.png](https://s1.ax1x.com/2023/05/22/p9oNYy6.md.png)](https://imgse.com/i/p9oNYy6)

当然除此之外，还有当可信性是true，是否匹配是false，但是资产仍然是自身资产的情况，也就是我们上文中提到的案例，也可以通过语法：`cert="abchina.com.cn" && cert.is_valid=true && cert.is_match=false`直接获取到。

[![p9TuMNV.md.png](https://s1.ax1x.com/2023/05/23/p9TuMNV.md.png)](https://imgse.com/i/p9TuMNV)




## 写在最后 ##
关于新添加的证书验证语法，可以在资产收集的过程中起到了很大的作用，包括FOFA开放实验室里的攻击面梳理也已经应用了这个语法。

同时这种判断方式的语法可以单一使用，也可以多组合使用，更大程度上地给到了大家可选性。欢迎各位表哥们在 https://en.fofa.info 开发这套语法，发现他更多的新姿势。




